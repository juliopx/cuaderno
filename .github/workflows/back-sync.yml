name: Back-Sync main to develop

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.ADMIN_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase develop onto main
        run: |
          git fetch origin main develop
          
          # Checkout develop
          git checkout origin/develop -b develop
          
          # Attempt rebase onto main
          # This rewrites develop history to be linear on top of main
          echo "üîÑ Attempting to rebase develop onto main..."
          if git rebase origin/main; then
            echo "‚úÖ Rebase successful"
            
            # Force push develop to apply the new linear history
            # NOTE: This requires 'Allow force pushes' on develop branch in GitHub settings
            echo "üöÄ Force pushing to develop..."
            git push origin develop --force || {
              echo "‚ùå Force push failed! Check branch protection rules for 'develop'."
              echo "To fix: Go to Settings -> Branches -> 'develop' -> Allow force pushes"
              exit 1
            }
          else
            echo "‚ùå Rebase failed due to conflicts"
            git rebase --abort
            
            echo "‚ö†Ô∏è Falling back to Merge PR strategy (Merge Bubble will occur)"
            # Fallback logic could go here, but for now we error out to prompt manual fix
            # or we could revert to the merge strategy. 
            # Given user preference for "rebase", we fail to alert the issue.
            exit 1
          fi
